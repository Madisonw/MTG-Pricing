/* Sag-JS v0.3.0 saggingcouch.com
Licensed under Apache 2.0 */
(function(a){var b=Array.isArray||function(a){return Object.prototype.toString.call(a)=="[object Array]"},c;typeof require=="function"?c=require("url").parse:c=function(a){var b,c=document.createElement("a");return c.href=a,b={protocol:c.protocol,port:c.port||"80",hostname:c.hostname,path:c.pathname},b.host=c.host||b.hostname+":"+b.port,c.href.indexOf("@")&&(b.auth=c.href.substr(b.protocol.length+2,c.href.indexOf("@")-b.protocol.length-2)),b},a.AUTH_BASIC="AUTH_BASIC",a.AUTH_COOKIE="AUTH_COOKIE",a.serverFromURL=function(b){var d,e;if(!b||typeof b!="string")throw TypeError("You must provide a complete URL as a string.");return d=c(b),d.host=d.host.split(":"),e=a.server(d.host.shift(),d.host.shift()),d.auth&&(d.auth=d.auth.split(":"),e.login({user:d.auth[0],pass:d.auth[1]})),typeof d.path=="string"&&d.path.length>1&&e.setDatabase(d.path.split("/")[1]),e},a.server=function(c,d,e,f){function r(){if(!l)throw new Error("Must setDatabase() first.")}function s(a){if(typeof Buffer=="function")return(new Buffer(a)).toString("base64");if(typeof btoa=="function")return btoa(a);throw new Error("No base64 encoder available.")}function t(a,b,c,d){var e={_HTTP:{status:a},headers:b},f,g;if(typeof c=="string")try{e.body=c.length>0&&k?JSON.parse(c):c}catch(h){e.body=c}if(b["set-cookie"]){e.cookies={};for(f in b["set-cookie"])b["set-cookie"].hasOwnProperty(f)&&(g=b["set-cookie"][f].split(";")[0].split("="),e.cookies[g[0]]=g[1],g=null)}e._HTTP.status>=400&&q._notify("error",e),typeof d=="function"&&d(e,e._HTTP.status<400)}function u(b,e,f,j,k){var l="",m,q;j=j||{},j["Content-Type"]||(j["Content-Type"]="application/json"),f&&typeof f!="string"&&(f=JSON.stringify(f));for(m in n)n.hasOwnProperty(m)&&(l+=m+"="+n[m]+";");l&&(i&&console&&typeof console.log=="function"&&console.log("Sending Cookie header, but do not expect any cookies in the result - CouchDB uses httpOnly cookies."),j.Cookie=(j.Cookie?j.Cookie:"")+l),o&&(e=o+e);if(p.type===a.AUTH_BASIC&&(p.user||p.pass))j.Authorization="Basic "+s(p.user+":"+p.pass);else if(p.type===a.AUTH_COOKIE){if(h&&typeof g.getCookie("AuthSession")!="string")throw new Error("Trying to use cookie auth, but we never got an AuthSession cookie from the server.");j["X-CouchDB-WWW-Authenticate"]="Cookie"}if(h)j["User-Agent"]="Sag-JS/0.1",q=h.request({method:b,host:c,port:d,path:e,headers:j},function(a){var c;a.setEncoding("utf8"),b!=="HEAD"&&(c="",a.on("data",function(a){c+=a})),a.on("end",function(){t(a.statusCode,a.headers,c,k)})}),q.on("error",function(a){console.log("problem with request: "+a)}),f&&q.write(f),q.end();else{if(!i)throw new Error("coder fail");i.onreadystatechange=function(){var a={},c,d;if(this.readyState===4&&this.status>0){c=this.getAllResponseHeaders().split("\n");for(d in c)c.hasOwnProperty(d)&&(c[d]=c[d].split(": "),c[d][1]&&(a[c[d][0].toLowerCase()]=c[d][1].trim()));t(this.status,a,b!=="HEAD"?this.response:null,k)}},i.open(b,"http://"+c+":"+d+e);for(m in j)j.hasOwnProperty(m)&&i.setRequestHeader(m,j[m]);i.send(f||null)}}function v(a,b,c){if(typeof a!="string")throw new Error("URLs must be a string");return j?(a=j.parse(a),a.search=(a.search?a.search+"&":"?")+b+"="+c,a=j.format(a)):(a=a.split("?"),a[1]=(a[1]?a[1]+"&":"")+b+"="+c,a=a.join("?")),a}var g,h,i,j,k=!0,l,m=!1,n={},o="",p={},q={_notify:function(a,b){var c;if(this[a])for(c in this[a])this[a].hasOwnProperty(c)&&typeof this[a][c]=="function"&&this[a][c](b)},error:[]};c=c||"localhost",d=d||"5984";if(typeof XMLHttpRequest=="function")i=new XMLHttpRequest;else if(typeof ActiveXObject=="function")i=new ActiveXObject("Microsoft.XMLHTTP");else if(typeof require=="function")h=require("http"),j=require("url");else throw new Error("whoops");return g={get:function(a){r();if(typeof a!="object")throw new Error("invalid opts object");if(typeof a.url!="string")throw new Error("invalid url type");if(a.callback&&typeof a.callback!="function")throw new Error("invalid callback type");a.url.substr(0,1)!=="/"&&(a.url="/"+a.url),m&&(a.url=v(a.url,"stale","ok")),u("GET","/"+l+a.url,null,null,a.callback)},post:function(a){var b;r();if(typeof a!="object")throw new Error("invalid opts object");if(a.data===null||a.data===undefined)throw new Error("you must specify data to POST");b="/"+l;if(a.url){if(typeof a.url!="string")throw new Error("Invalid url type (must be a string).");a.url.substr(0,1)!=="/"&&(b+="/"),b+=a.url}u("POST",b,a.data,null,a.callback)},decode:function(a){return k=!!a,g},setDatabase:function(a,b,c){if(typeof a=="string"&&a.length>0){if(c){if(!b)throw new Error("Provided a callback but told not to check if the database exists.");if(typeof c!="function")throw new Error("Invalid callback type.");u("GET","/"+a,null,null,function(b){b._HTTP.status===404?g.createDatabase(a,function(a){c(a._HTTP.status===201)}):b._HTTP.status<400?c(!0):c(!1)})}return l=a,g}throw new Error("invalid database name")},currentDatabase:function(){return l},getAllDatabases:function(a){u("GET","/_all_dbs",null,null,a)},getStats:function(a){r();if(typeof a!="function")throw new Error("Invalid callback.");u("GET","/_stats",null,null,a)},generateIDs:function(a){var b="/_uuids";if(typeof a!="object")throw new Error("Missing required opts.");if(typeof a.count=="number")b+="?count="+a.count;else if(typeof a.count!="undefined")throw new Error("Invalid count type");u("GET",b,null,null,a.callback)},put:function(a){if(typeof a!="object")throw new Error("Missing required opts.");r();if(a.callback&&typeof a.callback!="function")throw new Error("Invalid callback");if(!a.id)throw new Error("Must specify an id.");if(typeof a.id!="string")throw new Error("Invalid id type (must be a string).");if(!a.data)throw new Error("Invalid data: must specify data (a document) to PUT.");if(!a.data._id)throw new Error("No _id specified in the data.");if(typeof a.data._id!="string")throw new Error("Invalid _id specific (must be a string).");if(typeof a.data=="object"||b(a.data))a.data=JSON.stringify(a.data);else if(typeof a.data!="string")throw new Error("Invalid data: must be a string of JSON or an object or array to be encoded as JSON.");u("PUT","/"+l+"/"+a.id,a.data,null,a.callback)},"delete":function(a,b,c){r();if(!a||typeof a!="string")throw new Error("Invalid id");if(!b||typeof b!="string")throw new Error("Invalid rev");if(c&&typeof c!="function")throw new Error("Invalid callback type");return u("DELETE","/"+l+"/"+a,null,{"If-Match":b},c),g},head:function(a){if(typeof a!="object")throw new Error("Missing required opts.");r();if(typeof a.url!="string"||!a.url)throw new Error("Invalid URL provided");a.url.substr(0,1)!=="/"&&(a.url="/"+a.url);if(a.callback&&typeof a.callback!="function")throw new Error("Invalid callback type");return u("HEAD","/"+l+a.url,null,null,a.callback),g},getSession:function(a){if(a&&typeof a!="function")throw new Error("Invalid callback type");u("GET","/_session",null,null,a)},bulk:function(a){var c={};if(typeof a!="object")throw new Error("Missing required opts.");r();if(!a.docs||!b(a.docs))throw new Error("Invalid docs provided.");if(a.callback&&typeof a.callback!="function")throw new Error("Invalid callback type");a.allOrNothing&&(c.all_or_nothing=!!a.allOrNothing),c.docs=a.docs,u("POST","/"+l+"/_bulk_docs",c,null,a.callback)},compact:function(a){var b;if(typeof a!="object")throw new Error("Missing required opts.");r(),b="/"+l+"/_compact";if(a.viewName){if(typeof a.viewName!="string")throw new Error("Invalid viewName provided.");b+="/"+a.viewName}if(a.callback&&typeof a.callback!="function")throw new Error("Invalid callback type.");u("POST",b,null,null,a.callback)},copy:function(a){if(typeof a!="object")throw new Error("Missing required opts.");r();if(!a.srcID||typeof a.srcID!="string")throw new Error("Invalid srcID.");if(!a.dstID||typeof a.dstID!="string")throw new Error("Invalid dstID.");if(a.dstRev){if(typeof a.dstRev!="string")throw new Error("Invalid dstRev.");a.dstID+="?rev="+a.dstRev}if(a.callback&&typeof a.callback!="function")throw new Error("Invalid callback type.");u("COPY","/"+l+"/"+a.srcID,null,{Destination:a.dstID},a.callback)},setStaleDefault:function(a){return m=!!a,g},createDatabase:function(a,b){if(!a||typeof a!="string")throw new Error("Invalid database name.");if(b&&typeof b!="function")throw new Error("Invalid callback type.");u("PUT","/"+a,null,null,b)},deleteDatabase:function(a,b){if(!a||typeof a!="string")throw new Error("Invalid database name.");if(b&&typeof b!="function")throw new Error("Invalid callback type.");u("DELETE","/"+a,null,null,b)},setAttachment:function(a){var b;r();if(!a.name||typeof a.name!="string")throw new Error("Invalid attachment name.");if(!a.data||typeof a.data!="string")throw new Error("Invalid attachment data - remember to serialize it to a string!");if(!a.contentType||typeof a.contentType!="string")throw new Error("Invalid contentType.");if(!a.docID||typeof a.docID!="string")throw new Error("Invalid docID.");if(a.docRev&&typeof a.docRev!="string")throw new Error("Invalid attachment docRev.");if(a.callback&&typeof a.callback!="function")throw new Error("Invalid callback type.");b="/"+l+"/"+a.docID+"/"+a.name,a.docRev&&(b+="?rev="+a.docRev),u("PUT",b,a.data,{"Content-Type":a.contentType},a.callback)},setCookie:function(a,b){if(!a||typeof a!="string")throw new Error("Invalid cookie key.");if(b!==null&&typeof b!="string")throw new Error("Invalid non-string and non-null cookie value.");return b===null?delete n[a]:n[a]=b,g},getCookie:function(a){if(!a||typeof a!="string")throw new Error("Invalid cookie key.");return n[a]},replicate:function(a){var b={};if(typeof a!="object")throw new Error("Invalid parameter.");if(!a.source||typeof a.source!="string")throw new Error("Invalid source.");if(!a.target||typeof a.target!="string")throw new Error("Invalid target");if(a.filter&&typeof a.filter!="string")throw new Error("Invalid filter.");if(a.callback&&typeof a.callback!="function")throw new Error("Invalid callback type.");if(a.filterQueryParams){if(typeof a.filterQueryParams!="object")throw new Error("Invalid filterQueryParams.");if(!a.filter)throw new Error("Provided filterQueryParams but no filter.")}b.source=a.source,b.target=a.target,a.continuous&&(b.continuous=!!a.continuous),a.createTarget&&(b.create_target=!!a.createTarget),a.filter&&(b.filter=a.filter,a.filterQueryParams&&(b.filterQueryParams=a.filterQueryParams)),u("POST","/_replicate",b,null,a.callback)},getAllDocs:function(a){var c,d=[];if(typeof a!="object")throw new Error("Invalid parameter.");a.includeDocs&&d.push("include_docs=true");if(a.limit){if(typeof a.limit!="number")throw new Error("Invalid limit.");d.push("limit="+a.limit)}if(a.startKey){if(typeof a.startKey!="string")throw new Error("Invalid startKey.");d.push("startkey="+encodeURIComponent(a.startKey))}if(a.endKey){if(typeof a.endKey!="string")throw new Error("Invalid endKey.");d.push("endkey="+encodeURIComponent(a.endKey))}a.descending&&d.push("descending=true"),d="?"+d.join("&"),c="/"+l+"/_all_docs"+d;if(a.keys){if(!b(a.keys))throw new Error("Invalid keys (not an array).");u("POST",c,{keys:a.keys},null,a.callback)}u("GET",c,null,null,a.callback)},setPathPrefix:function(a){if(a!==undefined&&a!==null&&typeof a!="string")throw new Error("Invalid path prefix.");return a.substr(a.length-1,1)=="/"&&(a=a.substr(0,a.length-1)),o=a||"",g},login:function(b){if(typeof b!="object")throw new Error("Invalid options object.");if(b.callback&&typeof b.callback!="function")throw new Error("Invalid callback.");if(b.user&&typeof b.user!="string")throw new Error("Invalid user.");if(b.pass&&typeof b.pass!="string")throw new Error("Invalid pass.");if(b.type&&typeof b.type!="string")throw new Error("Invalid type of auth - use AUTH_BASIC or AUTH_COOKIE.");if(!b.type||b.type===a.AUTH_BASIC){p.type=a.AUTH_BASIC,p.user=b.user,p.pass=b.pass;if(b.callback)b.callback(g);else return g}else{if(b.type!==a.AUTH_COOKIE)throw new Error("Unknown auth type.");u("POST","/_session","name="+b.user+"&password="+b.pass,{"Content-Type":"application/x-www-form-urlencoded"},function(a){a.cookies&&a.cookies.AuthSession&&(g.setCookie("AuthSession",a.cookies.AuthSession),p.type=b.type),b.callback&&b.callback(g)});if(!b.callback)return g}},on:function(a,b){if(q[a])q[a].push(b);else throw new Error("Invalid event name.");return g},toString:function(){var a="http://";return p&&p.user&&(a+=p.user+":"+(p.pass||"")+"@"),a+=c,d&&(a+=":"+d),l&&(a+="/"+l),a}},g}})(typeof exports=="object"?exports:this.sag={});